name: upload artifacts to packagecloud

on:
  workflow_call:
    secrets:
      PACKAGECLOUD_TOKEN:
        required: true
    inputs:
      USERREPO:
        required: true
        type: string

jobs:

  upload-packagecloud:
    name: ${{ matrix.vendor }} upload
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - vendor: "ubuntu"
          - vendor: "debian"

    steps:
      - name: download artifacts
        uses: actions/download-artifact@v3
      - name: install
        run: |
          gem install package_cloud
          echo "PACKAGECLOUD_TOKEN=${{ secrets.PACKAGECLOUD_TOKEN }}" >> $GITHUB_ENV
      - name: upload
        run: |
          for resultdir in $(ls -d results-${{ matrix.vendor }}*); do
            dist=$(grep -oP "Distribution: \K\w+" $resultdir/*.changes)
            find $resultdir \( -name "*.deb" -o -name "*.dsc" \) | xargs -r package_cloud push ${{ inputs.USERREPO }}/${{ matrix.vendor }}/$dist
          done
