name: git-buildpackage native packaging

on:
  workflow_call:
    secrets:
      GPG_PRIVATE_KEY:
        required: true
    inputs:
      DEBFULLNAME:
        required: true
        type: string
      DEBEMAIL:
        required: true
        type: string
      before_build_deps_install:
        type: string
      images:
        description: 'JSON array of distro container images to build for (e.g. ["ubuntu:latest", "debian:stable"]).'
        type: string
        default: '["ubuntu:latest", "debian:stable"]'
      architectures:
        description: 'JSON array of architectures to build for (any of ["amd64", "arm64"]).'
        type: string
        default: '["amd64"]'

env:
  DEBFULLNAME: ${{ inputs.DEBFULLNAME }}
  DEBEMAIL: ${{ inputs.DEBEMAIL }}

jobs:

  prepare-matrix:
    name: Prepare build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Generate matrix
        id: generate-matrix
        run: |
          # Parse inputs and create combined matrix
          IMAGES='${{ inputs.images }}'
          ARCHES='${{ inputs.architectures }}'

          # Normalize images to objects with image and distro keys
          IMAGES_NORMALIZED=$(echo "$IMAGES" | jq -c 'map(
            if type == "string" then 
              {image: ., distro: (. | gsub("[:/]"; "-"))}
            elif has("distro") then .
            else . + {distro: (.image | gsub("[:/]"; "-"))}
            end
          )')

          # Normalize architectures to objects with arch and runner keys
          # GitHub runners: ubuntu-latest (x64), ubuntu-24.04-arm (ARM)
          ARCHES_NORMALIZED=$(echo "$ARCHES" | jq -c 'map(
            if . == "arm64" or . == "armhf" or . == "armv7" then 
              {arch: ., runner: "ubuntu-24.04-arm"}
            else 
              {arch: ., runner: "ubuntu-24.04"}
            end
          )')

          # Check if there are any architecture-dependent packages
          # If any Architecture field is not "all", there are arch-dependent packages
          HAS_ARCH_PACKAGES=false
          if grep -E '^Architecture:' debian/control 2>/dev/null | grep -qvE ':\s*all\s*$'; then
            HAS_ARCH_PACKAGES=true
          fi

          # Deduplicate images by digest, then expand with architectures
          MATRIX=$(echo "$IMAGES_NORMALIZED" | jq -r '.[] | @json' | while IFS= read -r distro_item; do
            image=$(echo "$distro_item" | jq -r '.image')
            distro=$(echo "$distro_item" | jq -r '.distro')

            # Get digest for the container image
            digest=$(docker buildx imagetools inspect "$image" --format '{{.Manifest.Digest}}')

            echo "$distro_item" | jq -c --arg digest "$digest" '. + {digest: $digest}'
          done | jq -sc --argjson arches "$ARCHES_NORMALIZED" --argjson has_arch "$HAS_ARCH_PACKAGES" '
            # Deduplicate images by digest
            reduce .[] as $distro (
              {seen: {}, images: []};
              if .seen[$distro.digest] then
                .  # Skip duplicate distro
              else
                .seen[$distro.digest] = true |
                .images += [$distro]
              end
            ) |
            # Expand each unique image with architectures
            .images |
            map(
              . as $d |
              if $has_arch then
                # Include all architectures
                $arches | to_entries | map(
                  {
                    image: $d.image,
                    distro: $d.distro,
                    arch: .value.arch,
                    runner: .value.runner,
                    is_primary: (.key == 0)  # First arch is primary
                  }
                )
              else
                # Only include first architecture
                [{
                  image: $d.image,
                  distro: $d.distro,
                  arch: $arches[0].arch,
                  runner: $arches[0].runner,
                  is_primary: true
                }]
              end
            ) | flatten | {include: .}
          ')

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build-native:
    name: ${{ matrix.distro }} (${{ matrix.arch }})
    needs: prepare-matrix
    runs-on: ${{ matrix.runner }}

    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    container:
      image: ${{ matrix.image }}
      env:
        DEBIAN_FRONTEND: noninteractive

    steps:
      # because job is in container
      - name: latest git from backports
        # https://github.com/actions/runner/issues/1533
        shell: bash
        run: |
          # https://github.com/actions/runner-images/issues/675
          echo 'Acquire::Retries "3";' | tee /etc/apt/apt.conf.d/99ci

          # install git
          apt-get update
          apt-get install -y git
      - name: check out
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          path: source
      - name: install
        # https://github.com/actions/runner/issues/1533
        shell: bash
        run: |
          git config --global user.name "${DEBFULLNAME}"
          git config --global user.email "${DEBEMAIL}"

          apt-get install -y debhelper-compat git-buildpackage equivs
      - name: build deb
        # https://github.com/actions/runner/issues/1533
        shell: bash
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import

          . /etc/os-release

          ${{ inputs.before_build_deps_install }}

          # install build depends and remove resulting clutter
          mk-build-deps -i -r source/debian/control -t "apt-get -y -o Debug::pkgProblemResolver=yes --no-install-recommends --yes"
          rm -f *.deb *.buildinfo *.changes

          pushd source

          PARENTVERSION=$(dpkg-parsechangelog --show-field Version)
          dch -b -D "${VERSION_CODENAME}" -v "${PARENTVERSION}~${VERSION_CODENAME}" "Release for ${VERSION_CODENAME}"
          git add .
          git commit -m "Update changelog for $(dpkg-parsechangelog --show-field Version) release"

          # Primary architecture: full build (source + all binaries), secondaries: binary-arch only (no _all packages)
          if [ "${{ matrix.is_primary }}" = "true" ]; then
            gbp buildpackage -F --git-export-dir=.. --git-ignore-branch
          else
            gbp buildpackage -B --git-export-dir=.. --git-ignore-branch
          fi

          popd
      - name: upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: results_${{ matrix.distro }}_${{ matrix.arch }}
          retention-days: 1
          path: |
            *.buildinfo
            *.changes
            *.ddeb
            *.deb
            *.dsc
            *.tar*
